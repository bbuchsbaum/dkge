---
title: "Components and Interpretability"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: false
    df_print: paged

vignette: >
  %\VignetteIndexEntry{Components and Interpretability}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(dkge)
library(ggplot2)
library(tidyr)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.width = 6,
  fig.height = 4,
  out.width = "90%"
)
options(
  tibble.print_min = 4,
  tibble.print_max = 4,
  digits = 3
)
set.seed(2024)
theme_set(theme_dkge())
```


This vignette demonstrates how to interpret the components extracted by DKGE, shows techniques for rotating them to achieve specific interpretations when needed, and explains how to project new data into the fitted component space.

## Example Fit

```{r fit}
library(dkge)
S <- 4; q <- 5; P <- 18; T <- 70
betas <- replicate(S, matrix(rnorm(q * P), q, P), simplify = FALSE)
designs <- replicate(S, {
  X <- matrix(rnorm(T * q), T, q)
  qr.Q(qr(X))
}, simplify = FALSE)
subjects <- lapply(seq_len(S), function(s) dkge_subject(betas[[s]], designs[[s]], id = paste0("sub", s)))
 bundle <- dkge_data(subjects)
fit <- dkge(bundle, kernel = diag(q), rank = 3)
```

## Inspect Loadings and Scores

```{r loadings}
round(fit$U, 3)         # effect-space loadings
lapply(fit$Btil, function(Bts) round(Bts[, 1:3, drop = FALSE], 2))[1]
```

The columns of `fit$U` represent the loadings for each component in the effect space. These loadings define how the original design effects combine to form the extracted components. The `Btil` element stores the subject-specific beta matrices after row-standardization, which ensures comparable scaling across subjects. To obtain cluster scores for each component, these standardized betas are multiplied with the corresponding columns of `fit$U`.

## Projecting Subjects into Component Space

```{r project}
subject_scores <- dkge_project_btil(fit, fit$Btil)
str(subject_scores, max.level = 1)
```

Each subject score matrix has dimensions clusters Ã— components, providing a complete mapping of how each brain cluster expresses each component. Computing average scores across subjects provides a useful summary that reveals the overall spatial patterns of component expression.

```{r score-plot, fig.height=4, fig.width=5, fig.alt="Line plot showing average DKGE component scores across clusters."}
avg_scores <- Reduce("+", subject_scores) / length(subject_scores)
avg_df <- as.data.frame(avg_scores)
component_cols <- paste0("Component ", seq_len(ncol(avg_df)))
names(avg_df) <- component_cols
avg_df$Cluster <- seq_len(nrow(avg_df))
avg_long <- tidyr::pivot_longer(avg_df,
                                cols = component_cols,
                                names_to = "Component",
                                values_to = "Score")

ggplot(avg_long, aes(x = Cluster, y = Score, colour = Component)) +
  geom_line(linewidth = 1.1) +
  labs(title = "Average component scores", y = "Score") +
  scale_x_continuous(breaks = seq_len(nrow(avg_scores))) +
  theme(legend.position = "top")
```

## Rotating Components

The `dkge_procrustes_K()` function provides a principled way to rotate components toward a target basis, such as canonical contrasts or previously established loadings from prior studies. This rotation preserves the mathematical properties of the solution by staying within the design-kernel metric space.

```{r rotate}
# target basis: identity for first two effects
B_target <- diag(1, q)[, 1:2]
rot <- dkge_procrustes_K(fit$U[, 1:2], B_target, fit$K)
round(rot$R, 3)
```

The rotation matrix `rot$R` can then be applied by multiplying it with the original loadings to obtain the aligned components that are oriented toward the target basis.

## Projecting New Data

```{r new-data}
new_beta <- matrix(rnorm(q * P), q, P)
projected <- dkge_project_clusters(fit, new_beta)
head(projected)
```

The `dkge_project_clusters()` function returns component scores for each cluster in the new data, providing a standardized representation that is ready for subsequent analyses such as contrast testing or optimal transport mapping to reference parcellations.

## Interpreting Components

Several approaches can help with interpreting the extracted components. First, examining `fit$weights` reveals which subjects contribute most strongly to each component, providing insight into individual differences in component expression. Second, plotting the rows of `fit$v` (the cluster-space loadings) helps identify the spatial patterns that characterize each component across brain regions. Finally, the `dkge_component_stats()` function from the inference vignette can be used to obtain statistical evidence for the significance of each component.
