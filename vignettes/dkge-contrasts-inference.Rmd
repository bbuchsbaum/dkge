---
title: "Contrasts, Inference, and Bootstraps"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Contrasts, Inference, and Bootstraps}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
set.seed(2)
```

This vignette shows how to generate subject-level contrasts with DKGE, apply
analytic and bootstrap inference, and read the outputs.

## Demo Dataset

```{r data}
library(dkge)
S <- 5; q <- 4; P <- 25; T <- 60
betas <- replicate(S, matrix(rnorm(q * P), q, P), simplify = FALSE)
designs <- replicate(S, {
  X <- matrix(rnorm(T * q), T, q)
  qr.Q(qr(X))
}, simplify = FALSE)
centroids <- replicate(S, matrix(runif(P * 3, -10, 10), P, 3), simplify = FALSE)
subjects <- lapply(seq_len(S), function(s) dkge_subject(betas[[s]], designs[[s]], id = paste0("sub", s)))
 bundle <- dkge_data(subjects)
fit <- dkge(bundle, kernel = diag(q), rank = 3)
fit$centroids <- centroids
```

## Leave-One-Subject-Out (LOSO) Contrasts

`dkge_loso_contrast()` computes cross-validated subject contrasts while keeping
transport operators consistent across folds.

```{r loso}
contrast_vec <- c(1, -1, 0, 0)  # effect1 minus effect2
loso <- dkge_contrast(fit, contrast_vec, method = "loso")

transported <- dkge_transport_contrasts_to_medoid(
  fit,
  loso,
  medoid = 1L,
  centroids = centroids,
  mapper = dkge_mapper("sinkhorn", epsilon = 0.05, lambda_xyz = 1)
)

str(loso$values, max.level = 1)
```

- `loso$values`: subject-level contrast vectors before transport.
- `transported[[1]]$value`: medoid-aligned contrast values averaged across subjects.
- `transported[[1]]$subj_values`: individual-subject contributions after transport.

Plot the LOSO medoid map for quick inspection.

```{r loso-plot, fig.width=5, fig.height=4, fig.alt="Lollipop plot of LOSO contrast values on medoid clusters."}
loso_medoid <- transported[[1]]$value
plot(loso_medoid, type = "h", lwd = 2, main = "LOSO contrast on medoid clusters",
     xlab = "Medoid cluster", ylab = "Contrast value")
abline(h = 0, col = "grey60", lty = 2)
```

## Analytic Inference on Components

`dkge_component_stats()` combines subject loadings, optionally performs
sign-flip inference, and returns FDR-adjusted summaries.

```{r analytic}
comp_stats <- dkge_component_stats(
  fit,
  components = 1:2,
  mapper = list(strategy = "sinkhorn", epsilon = 0.05, lambda_spa = 0.5),
  centroids = centroids,
  inference = list(type = "parametric"),
  medoid = 1L
)
head(comp_stats$summary)
```

The `summary` tibble includes component id, cluster index, statistic, and both
raw and adjusted p-values; use it to select clusters surpassing your threshold.

## Bootstrap Inference

When effect distributions deviate from Gaussian assumptions, run multiplier or
resampling bootstraps. The analytic fit above can be re-used to seed bootstrap
runs.

```{r bootstrap, message=FALSE}
subject_medoid <- lapply(seq_len(nrow(transported[[1]]$subj_values)), function(idx) {
  transported[[1]]$subj_values[idx, ]
})

boot <- dkge_bootstrap_projected(
  subject_medoid,
  B = 200,
  seed = 2
)

head(boot$medoid$mean)
```

`dkge_bootstrap_projected()` returns confidence intervals and standard errors for
medoid space contrasts. Swap in `dkge_bootstrap_qspace()` to work directly in the
component basis without spatial transport.

## Tips

- Analytic inference is fast and works well when subject counts are moderate and
  residuals appear symmetric.
- Bootstraps are robust but slower; rely on warm-started Sinkhorn transport to
  curb runtime (the package caches dual variables automatically).
- Always inspect `loso$subject_values` to detect outlier subjects before
  reporting group-level results.
